// Generated by CoffeeScript 1.6.2
var Monitor, argv, codeChange, fs, hrLog, hrLogId, logger, moment, notifier, path, project, relativeName, root, server, serverScript, spawn, srcMonitor, srvArgs, start, writeStderr, writeStdout, _;

fs = require('fs');

path = require('path');

spawn = require('child_process').spawn;

moment = require('moment');

_ = require('lodash');

Monitor = require('findr').Monitor;

argv = require('optimist').alias('d', 'debug').alias('b', 'break').argv;

logger = require('./loggers').get('console');

notifier = require('./loggers').get('notifier');

project = require('./project');

server = null;

hrLogId = null;

/*
add an horizontal line after each log to make it easier to read
*/


hrLog = function() {
  var hr, i, _i;

  hr = '';
  for (i = _i = 1; _i <= 50; i = ++_i) {
    hr += '.';
  }
  console.log(hr);
  console.log(moment().format('h:mm:ss - ddd MMM YY'));
  return console.log(hr);
};

writeStdout = function(data) {
  process.stdout.write(data);
  clearTimeout(hrLogId);
  return hrLogId = setTimeout(hrLog, 3000);
};

writeStderr = function(data) {
  process.stderr.write(data);
  clearTimeout(hrLogId);
  return hrLogId = setTimeout(hrLog, 3000);
};

/*
Server stuffs
*/


srvArgs = [];

serverScript = project.config.server.script;

if (argv.debug) {
  srvArgs.push('--debug');
}

if (argv["break"]) {
  srvArgs.push('--debug-brk');
}

srvArgs.push(path.resolve(__dirname, 'scriptWrapper.js'));

if (fs.existsSync(serverScript)) {
  start = function(msg) {
    msg || (msg = "Starting " + serverScript);
    notifier.info(msg, {
      title: 'Server'
    });
    server = spawn('node', srvArgs, {
      cwd: '.',
      env: _(process.env).extend(project.config.server.env, {
        SQ_SCRIPT: serverScript
      })
    });
    server.stdout.on('data', writeStdout);
    server.stderr.on('data', writeStderr);
    return server.once('exit', function(err) {
      if (!err) {
        return start("Restarting " + serverScript);
      }
    });
  };
}

/*
builder stuffs
*/


root = path.resolve('.');

relativeName = function(file) {
  return file != null ? file.substring(root.length) : void 0;
};

codeChange = function(err, file, newCode) {
  if (err) {
    return notifier.error(err.toString(), {
      title: relativeName(err.file)
    });
  }
  if (newCode) {
    return notifier.info("file compiled sucessfully", {
      title: relativeName(file) || srcMonitor.name
    });
  } else {
    return notifier.info("file unchanged", {
      title: relativeName(file) || srcMonitor.name
    });
  }
};

srcMonitor = new Monitor('src Monitor', path.resolve(project.config.src), project.filter);

srcMonitor.on('created', function(f) {
  if (project.fileFilter(f)) {
    return project.liveBuild(f, codeChange);
  }
});

srcMonitor.on('changed', function(f) {
  return project.liveBuild(f, codeChange);
});

srcMonitor.on('removed', function(f) {
  return project.removeBuild(f, codeChange);
});

srcMonitor.once('started', function(files) {
  notifier.info("Watching", {
    title: srcMonitor.name
  });
  return project.liveBuildAll(files, function(errors) {
    var e, _i, _len, _results;

    if (errors) {
      _results = [];
      for (_i = 0, _len = errors.length; _i < _len; _i++) {
        e = errors[_i];
        _results.push(notifier.error(e.toString(), {
          title: relativeName(e.file)
        }));
      }
      return _results;
    } else {
      notifier.info('Build done.', {
        title: srcMonitor.name
      });
      return typeof start === "function" ? start() : void 0;
    }
  });
});

srcMonitor.start();

/*
process stuff
*/


process.on('SIGINT', function(err) {
  if (server) {
    notifier.error('Killing server...');
    server.kill('SIGQUIT');
  }
  return process.exit();
});
